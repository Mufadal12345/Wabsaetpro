<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 420px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            z-index: 999;
        }
        
        .sidebar-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .draggable-item {
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .draggable-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .drop-zone {
            min-height: 200px;
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            border: 3px dashed #667eea;
            border-radius: 12px;
        }
        
        .widget-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .widget-container:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .category-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .secret-btn {
            opacity: 0.15;
            transition: opacity 0.3s ease;
        }
        
        .secret-btn:hover {
            opacity: 1;
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .toast {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            z-index: 9999;
            animation: slideDown 0.4s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        .material-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid #667eea40;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            .workspace-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="h-full w-full bg-gradient-to-br from-gray-50 to-gray-100">
    <div id="app" class="h-full w-full overflow-auto">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="loading-spinner mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
                <p class="text-2xl font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Main Container -->
        <div id="main-container" class="w-full h-full" style="display: none;">
            <!-- Top Header -->
            <header class="gradient-bg text-white shadow-xl sticky top-0 z-50">
                <div class="px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-3 hover:bg-white hover:bg-opacity-20 rounded-xl transition-all">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <div>
                                <h1 id="system-title" class="text-3xl font-bold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h1>
                                <p id="company-name" class="text-sm opacity-90 mt-1">Ø´Ø±ÙƒØªÙƒ Ù„Ù„Ø®Ø±Ø¯ÙˆØ§Øª</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <select id="user-role-selector" onchange="changeUserRole()" class="bg-white bg-opacity-20 text-white px-5 py-3 rounded-xl border-2 border-white border-opacity-30 font-bold text-lg cursor-pointer">
                                <option value="manager">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ±</option>
                                <option value="accountant">ğŸ“Š Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</option>
                                <option value="weigher">âš–ï¸ Ø§Ù„Ù…ÙˆØ²Ù†</option>
                                <option value="cashier">ğŸ’° Ø§Ù„ÙƒØ§Ø´ÙŠØ±</option>
                            </select>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Workspace Area -->
            <div class="w-full">
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„</h2>
                            <p id="current-date" class="text-gray-600 mt-1"></p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="toggleSidebar()" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition-all font-bold shadow-lg">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>
                            <button onclick="clearWorkspace()" class="bg-red-500 text-white px-6 py-3 rounded-xl hover:bg-red-600 transition-all font-bold shadow-lg">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                            <button onclick="saveWorkspace()" class="bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 transition-all font-bold shadow-lg">ğŸ’¾ Ø­ÙØ¸</button>
                        </div>
                    </div>
                    
                    <div id="workspace" class="workspace-grid drop-zone">
                        <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                            <svg class="w-24 h-24 mb-6 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <p class="text-2xl font-bold mb-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§</p>
                            <p class="text-lg">Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ø®ØªØ± Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sticky top-0 bg-white z-10 border-b-2 border-gray-200 p-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-xl transition-all">
                        <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Categories Section -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2"><span>ğŸ“‚</span> Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                    <div class="space-y-3">
                        <div class="category-card" onclick="showCategoryItems('materials')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl">ğŸ“¦</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</h4>
                                        <p class="text-sm text-gray-600">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</p>
                                    </div>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="category-card" onclick="showCategoryItems('transactions')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl">ğŸ’³</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                                        <p class="text-sm text-gray-600">Ø´Ø±Ø§Ø¡ØŒ Ø¨ÙŠØ¹ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
                                    </div>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="category-card" onclick="showCategoryItems('calculators')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl">ğŸ§®</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª</h4>
                                        <p class="text-sm text-gray-600">Ø­Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
                                    </div>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="category-card" onclick="showCategoryItems('reports')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl">ğŸ“Š</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
                                        <p class="text-sm text-gray-600">Ù…Ù„Ø®ØµØ§Øª Ù…Ø§Ù„ÙŠØ© ÙˆØªÙ‚Ø§Ø±ÙŠØ±</p>
                                    </div>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Items Container -->
                <div id="category-items" class="hidden">
                    <button onclick="backToCategories()" class="mb-4 flex items-center gap-2 text-purple-600 hover:text-purple-800 font-bold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19l7-7-7-7"></path>
                        </svg>
                        Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
                    </button>
                    <h3 id="category-title" class="text-xl font-bold text-gray-700 mb-4"></h3>
                    <div id="items-list" class="space-y-3"></div>
                </div>

                <!-- Materials Library -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2"><span>ğŸ“š</span> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
                    <div id="materials-sidebar" class="space-y-2"></div>
                </div>
            </div>
        </aside>

        <!-- Modal Container -->
        <div id="modal-container"></div>
    </div>

    <script>
        const defaultConfig = {
            system_title: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ",
            company_name: "Ø´Ø±ÙƒØªÙƒ Ù„Ù„Ø®Ø±Ø¯ÙˆØ§Øª",
            welcome_message: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø¯ÙˆØ§Øª",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            background_color: "#f9fafb"
        };

        let allData = [];
        let isLoading = false;
        let currentUserRole = 'manager';
        let workspaceWidgets = [];
        let draggedItem = null;

        const categoryItems = {
            materials: [
                { id: 'add-material', icon: 'â•', title: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©', description: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø¨Ø¶Ø§Ø¹Ø© Ù„Ù„Ù†Ø¸Ø§Ù…', action: 'showAddMaterialForm' },
                { id: 'materials-list', icon: 'ğŸ“‹', title: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯', description: 'Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯', widget: 'materials-manager' },
                { id: 'price-editor', icon: 'ğŸ’°', title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', description: 'ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯', widget: 'price-adjuster', role: 'accountant' },
                { id: 'inventory-tracker', icon: 'ğŸ“ˆ', title: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', description: 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', widget: 'inventory-tracker' }
            ],
            transactions: [
                { id: 'purchase-form', icon: 'ğŸ“¥', title: 'ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡', description: 'Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', action: 'showAddPurchaseForm' },
                { id: 'sale-form', icon: 'ğŸ“¤', title: 'ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹', description: 'Ø¨ÙŠØ¹ Ù…ÙˆØ§Ø¯ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡', action: 'showAddSaleForm' },
                { id: 'quick-sale', icon: 'âš¡', title: 'Ø¨ÙŠØ¹ Ø³Ø±ÙŠØ¹', description: 'ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ¹ Ø³Ø±ÙŠØ¹Ø©', widget: 'quick-sale', role: 'cashier' },
                { id: 'transaction-processor', icon: 'ğŸ”„', title: 'Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', description: 'Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', widget: 'transaction-processor' },
                { id: 'expenses-tracker', icon: 'ğŸ’¸', title: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', description: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', widget: 'expenses-tracker' }
            ],
            calculators: [
                { id: 'weighing-calc', icon: 'âš–ï¸', title: 'Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ù†', description: 'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø­Ø³Ø¨ Ø§Ù„ÙˆØ²Ù†', widget: 'weighing-calculator', role: 'weigher' },
                { id: 'general-calc', icon: 'ğŸ§®', title: 'Ø­Ø§Ø³Ø¨Ø© Ø¹Ø§Ù…Ø©', description: 'Ø­Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©', widget: 'general-calculator' },
                { id: 'profit-calc', icon: 'ğŸ“ˆ', title: 'Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­', description: 'Ø­Ø³Ø§Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­', widget: 'profit-calculator' }
            ],
            reports: [
                { id: 'financial-summary', icon: 'ğŸ“Š', title: 'Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ', description: 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©', widget: 'financial-summary', role: 'accountant' },
                { id: 'daily-report', icon: 'ğŸ“…', title: 'ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ', description: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', widget: 'daily-report' },
                { id: 'inventory-report', icon: 'ğŸ“¦', title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', description: 'ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', widget: 'inventory-report' },
                { id: 'sales-report', icon: 'ğŸ’°', title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', description: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', widget: 'sales-report' }
            ]
        };

        const rolePermissions = {
            manager: { 
                canEditPrices: true, 
                canViewFinancials: true, 
                canManageUsers: true, 
                canDeleteRecords: true, 
                canAddMaterials: true, 
                canProcessTransactions: true, 
                canAdjustPrices: true, 
                label: 'Ø§Ù„Ù…Ø¯ÙŠØ±',
                color: 'bg-purple-600'
            },
            accountant: { 
                canEditPrices: true, 
                canViewFinancials: true, 
                canManageUsers: false, 
                canDeleteRecords: false, 
                canAddMaterials: true, 
                canProcessTransactions: true, 
                canAdjustPrices: true, 
                label: 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨',
                color: 'bg-blue-600'
            },
            weigher: { 
                canEditPrices: false, 
                canViewFinancials: false, 
                canManageUsers: false, 
                canDeleteRecords: false, 
                canAddMaterials: false, 
                canProcessTransactions: true, 
                canAdjustPrices: false, 
                label: 'Ø§Ù„Ù…ÙˆØ²Ù†',
                color: 'bg-green-600'
            },
            cashier: { 
                canEditPrices: false, 
                canViewFinancials: false, 
                canManageUsers: false, 
                canDeleteRecords: false, 
                canAddMaterials: false, 
                canProcessTransactions: true, 
                canAdjustPrices: false, 
                label: 'Ø§Ù„ÙƒØ§Ø´ÙŠØ±',
                color: 'bg-yellow-600'
            }
        };

        class DataHandler {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('scrap_data')) || [];
                this.transactions = JSON.parse(localStorage.getItem('scrap_transactions')) || [];
                this.settings = JSON.parse(localStorage.getItem('scrap_settings')) || defaultConfig;
            }

            saveData() {
                localStorage.setItem('scrap_data', JSON.stringify(this.data));
                localStorage.setItem('scrap_transactions', JSON.stringify(this.transactions));
                localStorage.setItem('scrap_settings', JSON.stringify(this.settings));
            }

            createMaterial(material) {
                material.id = Date.now().toString();
                material.created_at = new Date().toISOString();
                material.type = 'material';
                this.data.push(material);
                this.saveData();
                return { isOk: true, data: material };
            }

            updateMaterial(id, updates) {
                const index = this.data.findIndex(item => item.id === id && item.type === 'material');
                if (index !== -1) {
                    this.data[index] = { ...this.data[index], ...updates, updated_at: new Date().toISOString() };
                    this.saveData();
                    return { isOk: true, data: this.data[index] };
                }
                return { isOk: false, error: 'Material not found' };
            }

            deleteMaterial(id) {
                const index = this.data.findIndex(item => item.id === id && item.type === 'material');
                if (index !== -1) {
                    this.data.splice(index, 1);
                    this.saveData();
                    return { isOk: true };
                }
                return { isOk: false, error: 'Material not found' };
            }

            createTransaction(transaction) {
                transaction.id = Date.now().toString();
                transaction.created_at = new Date().toISOString();
                this.transactions.push(transaction);
                this.saveData();
                return { isOk: true, data: transaction };
            }

            getMaterials() {
                return this.data.filter(item => item.type === 'material');
            }

            getTransactions(type = null) {
                if (type) {
                    return this.transactions.filter(t => t.type === type);
                }
                return this.transactions;
            }

            getFinancialSummary() {
                const purchases = this.transactions.filter(t => t.type === 'purchase');
                const sales = this.transactions.filter(t => t.type === 'sale');
                const expenses = this.transactions.filter(t => t.type === 'expense');

                const totalPurchases = purchases.reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0);
                const totalSales = sales.reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0);
                const totalExpenses = expenses.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                return {
                    totalPurchases,
                    totalSales,
                    totalExpenses,
                    profit: totalSales - totalPurchases - totalExpenses
                };
            }
        }

        const dataHandler = new DataHandler();

        async function initializeApp() {
            // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('ar-SA', {
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });

            // ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            loadWorkspace();

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯
            allData = dataHandler.getMaterials();
            updateUI();

            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            }, 1000);

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
            initializeDragAndDrop();
        }

        function updateUI() {
            renderMaterialsSidebar();
            renderWorkspace();
        }

        function renderMaterialsSidebar() {
            const materials = dataHandler.getMaterials();
            const container = document.getElementById('materials-sidebar');
            
            if (materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø©</p>';
                return;
            }

            container.innerHTML = materials.map(material => {
                return `
                    <div draggable="true" 
                         data-type="material" 
                         data-id="${material.id}"
                         data-name="${material.name}"
                         data-price="${material.price}"
                         data-unit="${material.unit}"
                         data-category="${material.category}"
                         ondragstart="handleDragStart(event)"
                         class="draggable-item bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 hover:border-blue-400 mb-2">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ğŸ“¦</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${material.name}</h4>
                                <p class="text-sm text-gray-600">${material.price} Ø±ÙŠØ§Ù„/${material.unit}</p>
                                <span class="material-tag mt-1">${material.category || 'Ø¹Ø§Ù…'}</span>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCategoryItems(category) {
            const items = categoryItems[category];
            const categoryTitles = {
                materials: 'ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹',
                transactions: 'ğŸ’³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                calculators: 'ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª',
                reports: 'ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'
            };

            document.querySelector('.space-y-3').parentElement.classList.add('hidden');
            document.getElementById('category-items').classList.remove('hidden');
            document.getElementById('category-title').textContent = categoryTitles[category];

            const itemsList = document.getElementById('items-list');
            itemsList.innerHTML = items.map(item => {
                const hasPermission = !item.role || checkPermission(item.role);
                if (!hasPermission) return '';

                return `
                    <div draggable="${item.widget ? 'true' : 'false'}" 
                         data-type="${item.widget ? 'widget' : 'action'}"
                         data-widget="${item.widget || ''}"
                         data-action="${item.action || ''}"
                         ondragstart="handleDragStart(event)"
                         onclick="${!item.widget ? item.action + '()' : 'addWidgetToWorkspace(\'' + item.widget + '\')'}"
                         class="draggable-item bg-white p-4 rounded-xl border-2 border-gray-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${item.icon}</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${item.title}</h4>
                                <p class="text-sm text-gray-600">${item.description}</p>
                            </div>
                            ${item.widget ? '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function backToCategories() {
            document.getElementById('category-items').classList.add('hidden');
            document.querySelector('.space-y-3').parentElement.classList.remove('hidden');
        }

        function checkPermission(role) {
            if (currentUserRole === 'manager') return true;
            const hierarchy = { manager: 4, accountant: 3, weigher: 2, cashier: 1 };
            return hierarchy[currentUserRole] >= hierarchy[role];
        }

        function initializeDragAndDrop() {
            const workspace = document.getElementById('workspace');

            workspace.addEventListener('dragover', (e) => {
                e.preventDefault();
                workspace.classList.add('drag-over');
            });

            workspace.addEventListener('dragleave', (e) => {
                if (e.target === workspace) {
                    workspace.classList.remove('drag-over');
                }
            });

            workspace.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            const type = e.target.dataset.type;
            draggedItem = {
                type: type,
                widget: e.target.dataset.widget || null,
                materialId: e.target.dataset.id || null,
                materialName: e.target.dataset.name || null,
                materialPrice: e.target.dataset.price || null,
                materialUnit: e.target.dataset.unit || null
            };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            const workspace = document.getElementById('workspace');
            workspace.classList.remove('drag-over');

            if (!draggedItem) return;

            if (draggedItem.type === 'widget') {
                addWidgetToWorkspace(draggedItem.widget);
            } else if (draggedItem.type === 'material') {
                addMaterialWidgetToWorkspace(draggedItem);
            }

            draggedItem = null;
            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„', 'success');
        }

        function addWidgetToWorkspace(widgetType) {
            const widgetInstance = {
                id: Date.now().toString(),
                type: widgetType,
                timestamp: new Date().toISOString()
            };

            workspaceWidgets.push(widgetInstance);
            renderWorkspace();
            saveWorkspace();
            toggleSidebar();
        }

        function addMaterialWidgetToWorkspace(material) {
            const widgetInstance = {
                id: Date.now().toString(),
                type: 'material-calculator',
                materialId: material.materialId,
                materialName: material.materialName,
                materialPrice: material.materialPrice,
                materialUnit: material.materialUnit,
                timestamp: new Date().toISOString()
            };

            workspaceWidgets.push(widgetInstance);
            renderWorkspace();
            saveWorkspace();
            toggleSidebar();
        }

        function renderWorkspace() {
            const workspace = document.getElementById('workspace');

            if (workspaceWidgets.length === 0) {
                workspace.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                        <svg class="w-24 h-24 mb-6 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <p class="text-2xl font-bold mb-2">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§</p>
                        <p class="text-lg">Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ø®ØªØ± Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡</p>
                    </div>
                `;
                return;
            }

            workspace.innerHTML = workspaceWidgets.map(widget => createWidgetHTML(widget)).join('');
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙŠÙŠØ±
            workspaceWidgets.forEach(widget => {
                if (widget.type === 'material-calculator') {
                    const weightInput = document.getElementById(`weight-${widget.id}`);
                    if (weightInput) {
                        weightInput.addEventListener('input', () => calculatePrice(widget.id));
                    }
                }
            });
        }

        function createWidgetHTML(widget) {
            switch(widget.type) {
                case 'material-calculator':
                    return createMaterialCalculatorWidget(widget);
                case 'weighing-calculator':
                    return createWeighingCalculatorWidget(widget);
                case 'price-adjuster':
                    return createPriceAdjusterWidget(widget);
                case 'financial-summary':
                    return createFinancialSummaryWidget(widget);
                case 'materials-manager':
                    return createMaterialsManagerWidget(widget);
                case 'quick-sale':
                    return createQuickSaleWidget(widget);
                case 'transaction-processor':
                    return createTransactionProcessorWidget(widget);
                case 'general-calculator':
                    return createGeneralCalculatorWidget(widget);
                case 'daily-report':
                    return createDailyReportWidget(widget);
                case 'inventory-tracker':
                    return createInventoryTrackerWidget(widget);
                case 'expenses-tracker':
                    return createExpensesTrackerWidget(widget);
                case 'profit-calculator':
                    return createProfitCalculatorWidget(widget);
                case 'inventory-report':
                    return createInventoryReportWidget(widget);
                case 'sales-report':
                    return createSalesReportWidget(widget);
                default:
                    return '';
            }
        }

        function createMaterialCalculatorWidget(widget) {
            const permissions = rolePermissions[currentUserRole];
            return `
                <div class="widget-container">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âš–ï¸</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${widget.materialName}</h3>
                                <p class="text-sm text-gray-600">${widget.materialPrice} Ø±ÙŠØ§Ù„/${widget.materialUnit}</p>
                            </div>
                        </div>
                        <button onclick="removeWidget('${widget.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆØ²Ù† (${widget.materialUnit})</label>
                            <input type="number" 
                                   step="0.01" 
                                   id="weight-${widget.id}" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-xl font-bold"
                                   placeholder="0.00">
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border-2 border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold text-gray-600">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span>
                                <span class="text-lg font-bold text-blue-600">${widget.materialPrice} Ø±ÙŠØ§Ù„/${widget.materialUnit}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                <span id="total-${widget.id}" class="text-3xl font-bold text-green-600">0 Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>

                        <button onclick="calculatePrice('${widget.id}')" 
                                class="w-full bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all">
                            ğŸ§® Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
                        </button>

                        <button onclick="processMaterialTransaction('${widget.id}')" 
                                class="w-full btn-primary text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg">
                            ğŸ’³ Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹
                        </button>
                    </div>
                </div>
            `;
        }

        function calculatePrice(widgetId) {
            const widget = workspaceWidgets.find(w => w.id === widgetId);
            if (!widget) return;

            const weightInput = document.getElementById(`weight-${widgetId}`);
            if (!weightInput) return;

            const weight = parseFloat(weightInput.value) || 0;
            const basePrice = parseFloat(widget.materialPrice);
            const total = weight * basePrice;

            const totalElement = document.getElementById(`total-${widgetId}`);
            if (totalElement) {
                totalElement.textContent = `${total.toFixed(2)} Ø±ÙŠØ§Ù„`;
            }
        }

        function processMaterialTransaction(widgetId) {
            const widget = workspaceWidgets.find(w => w.id === widgetId);
            if (!widget) return;

            const weightInput = document.getElementById(`weight-${widgetId}`);
            const totalElement = document.getElementById(`total-${widgetId}`);
            
            if (!weightInput || !totalElement) return;

            const weight = parseFloat(weightInput.value) || 0;
            const total = parseFloat(totalElement.textContent.replace(' Ø±ÙŠØ§Ù„', '')) || 0;

            if (weight <= 0) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ØµØ­ÙŠØ­', 'error');
                return;
            }

            const transaction = {
                type: 'sale',
                material_id: widget.materialId,
                material_name: widget.materialName,
                quantity: weight,
                unit_price: widget.materialPrice,
                total_amount: total,
                unit: widget.materialUnit,
                date: new Date().toISOString(),
                user_role: currentUserRole
            };

            dataHandler.createTransaction(transaction);
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            weightInput.value = '';
            totalElement.textContent = '0 Ø±ÙŠØ§Ù„';
        }

        function createWeighingCalculatorWidget(widget) {
            const materials = dataHandler.getMaterials();
            return `
                <div class="widget-container">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âš–ï¸</span>
                            <h3 class="text-xl font-bold text-gray-800">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙˆØ²Ù†</h3>
                        </div>
                        <button onclick="removeWidget('${widget.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition-all">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                            <select id="material-select-${widget.id}" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none font-bold">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>
                                ${materials.map(m => `
                                    <option value="${m.id}" data-price="${m.price}" data-unit="${m.unit}">
                                        ${m.name} - ${m.price} Ø±ÙŠØ§Ù„/${m.unit}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆØ²Ù†</label>
                            <input type="number" 
                                   step="0.01" 
                                   id="weight-calc-${widget.id}" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-xl font-bold"
                                   placeholder="0.00">
                        </div>
                        
                        <button onclick="calculateWeighing('${widget.id}')" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-bold">
                            ğŸ§® Ø§Ø­Ø³Ø¨
                        </button>
                        
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                <span id="total-calc-${widget.id}" class="text-3xl font-bold text-green-600">0 Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateWeighing(widgetId) {
            const select = document.getElementById(`material-select-${widgetId}`);
            const weightInput = document.getElementById(`weight-calc-${widgetId}`);
            const totalElement = document.getElementById(`total-calc-${widgetId}`);
            
            if (!select.value) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©', 'error');
                return;
            }
            
            const weight = parseFloat(weightInput.value) || 0;
            const price = parseFloat(select.options[select.selectedIndex].dataset.price);
            const total = weight * price;
            
            totalElement.textContent = `${total.toFixed(2)} Ø±ÙŠØ§Ù„`;
        }

        function createFinancialSummaryWidget(widget) {
            const summary = dataHandler.getFinancialSummary();
            return `
                <div class="widget-container bg-gradient-to-br from-purple-50 to-indigo-100">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ğŸ“Š</span>
                            <h3 class="text-xl font-bold text-gray-800">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                        </div>
                        <button onclick="removeWidget('${widget.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition-all">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-5 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">ğŸ“¥</span>
                                    <span class="text-sm font-bold text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                                </div>
                                <span class="text-2xl font-bold text-red-600">${summary.totalPurchases.toFixed(2)} Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">ğŸ“¤</span>
                                    <span class="text-sm font-bold text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                                </div>
                                <span class="text-2xl font-bold text-green-600">${summary.totalSales.toFixed(2)} Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">ğŸ’¸</span>
                                    <span class="text-sm font-bold text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
                                </div>
                                <span class="text-2xl font-bold text-orange-600">${summary.totalExpenses.toFixed(2)} Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-lg border-2 ${summary.profit >= 0 ? 'border-green-300' : 'border-red-300'}">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">ğŸ’°</span>
                                    <span class="text-sm font-bold text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span>
                                </div>
                                <span class="text-3xl font-bold ${summary.profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${summary.profit.toFixed(2)} Ø±ÙŠØ§Ù„
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createMaterialsManagerWidget(widget) {
            const materials = dataHandler.getMaterials();
            return `
                <div class="widget-container">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ğŸ“¦</span>
                            <h3 class="text-xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                        </div>
                        <button onclick="removeWidget('${widget.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition-all">
                            âœ•
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="showAddMaterialForm()" 
                                class="w-full btn-primary text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg">
                            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                        
                        <div class="bg-gray-50 p-4 rounded-xl">
                            <h4 class="font-bold text-gray-700 mb-3">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (${materials.length})</h4>
                            ${materials.length === 0 ? 
                                '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</p>' : 
                                `<div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${materials.map(m => `
                                        <div class="bg-white p-3 rounded-lg flex justify-between items-center hover:bg-gray-50">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">ğŸ“¦</span>
                                                <div>
                                                    <div class="font-bold text-gray-800">${m.name}</div>
                                                    <div class="text-sm text-gray-600">${m.category || 'Ø¹Ø§Ù…'} - ${m.price} Ø±ÙŠØ§Ù„/${m.unit}</div>
                                                </div>
                                            </div>
                                            <button onclick="deleteMaterial('${m.id}')" class="text-red-500 hover:text-red-700">
                                                âœ•
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function deleteMaterial(materialId) {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    dataHandler.deleteMaterial(materialId);
                    allData = dataHandler.getMaterials();
                    updateUI();
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            });
        }

        function showAddMaterialForm() {
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                        <div class="gradient-bg text-white p-6 rounded-t-2xl">
                            <h2 class="text-3xl font-bold">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                        </div>
                        <form id="material-form" class="p-8 space-y-6">
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                                <input type="text" name="name" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 text-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                                    <select name="category" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500">
                                        <option value="Ù…Ø¹Ø§Ø¯Ù†">Ù…Ø¹Ø§Ø¯Ù†</option>
                                        <option value="Ø£ÙˆØ±Ø§Ù‚">Ø£ÙˆØ±Ø§Ù‚</option>
                                        <option value="Ø¨Ù„Ø§Ø³ØªÙŠÙƒ">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                                        <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
                                        <option value="Ø²Ø¬Ø§Ø¬">Ø²Ø¬Ø§Ø¬</option>
                                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-bold mb-2">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                    <select name="unit" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500">
                                        <option value="ÙƒÙŠÙ„Ùˆ">ÙƒÙŠÙ„Ùˆ</option>
                                        <option value="Ø·Ù†">Ø·Ù†</option>
                                        <option value="ØºØ±Ø§Ù…">ØºØ±Ø§Ù…</option>
                                        <option value="Ù„ØªØ±">Ù„ØªØ±</option>
                                        <option value="Ù‚Ø·Ø¹Ø©">Ù‚Ø·Ø¹Ø©</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)</label>
                                <input type="number" step="0.01" name="price" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 text-lg">
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="flex-1 btn-primary text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg">
                                    Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø©
                                </button>
                                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-4 rounded-xl font-bold text-lg hover:bg-gray-300 transition-all">
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('material-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const materialData = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    unit: formData.get('unit'),
                    price: parseFloat(formData.get('price')),
                    type: 'material'
                };

                const result = dataHandler.createMaterial(materialData);
                
                if (result.isOk) {
                    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“', 'success');
                    allData = dataHandler.getMaterials();
                    updateUI();
                    closeModal();
                } else {
                    showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©', 'error');
                }
            });
        }

        function removeWidget(widgetId) {
            workspaceWidgets = workspaceWidgets.filter(w => w.id !== widgetId);
            renderWorkspace();
            saveWorkspace();
            showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ±', 'success');
        }

        function clearWorkspace() {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    workspaceWidgets = [];
                    renderWorkspace();
                    saveWorkspace();
                    showToast('ØªÙ… Ù…Ø³Ø­ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„', 'success');
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function changeUserRole() {
            currentUserRole = document.getElementById('user-role-selector').value;
            const role = rolePermissions[currentUserRole];
            document.querySelector('header').style.background = role.color;
            showToast(`ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${role.label}`, 'success');
        }

        function saveWorkspace() {
            localStorage.setItem('scrap_workspace', JSON.stringify(workspaceWidgets));
        }

        function loadWorkspace() {
            const saved = localStorage.getItem('scrap_workspace');
            if (saved) {
                workspaceWidgets = JSON.parse(saved);
                renderWorkspace();
            }
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white shadow-2xl`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ¯Ø¬Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        function createPriceAdjusterWidget(widget) {
            return `<div class="widget-container">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createQuickSaleWidget(widget) {
            return `<div class="widget-container">Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createTransactionProcessorWidget(widget) {
            return `<div class="widget-container">Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createGeneralCalculatorWidget(widget) {
            return `<div class="widget-container">Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createDailyReportWidget(widget) {
            return `<div class="widget-container">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createInventoryTrackerWidget(widget) {
            return `<div class="widget-container">ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createExpensesTrackerWidget(widget) {
            return `<div class="widget-container">ØªØªØ¨Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createProfitCalculatorWidget(widget) {
            return `<div class="widget-container">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createInventoryReportWidget(widget) {
            return `<div class="widget-container">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        function createSalesReportWidget(widget) {
            return `<div class="widget-container">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</div>`;
        }

        // Ø¯Ø§Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§
        function showAddPurchaseForm() {
            showToast('Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´Ø±Ø§Ø¡ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }

        function showAddSaleForm() {
            showToast('Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ¹ - Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
 </html>
